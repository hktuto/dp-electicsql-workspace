
# DocPal - Master Development Plan

## Project Overview

A low-code platform built with Nuxt + NuxtHub allowing users to create companies, workspaces, dynamic data tables, views, dashboards, and automation workflows.

## Tech Stack

- **Frontend**: Nuxt 4, Element Plus, SCSS + CSS Variables
- **Backend**: NuxtHub, PostgreSQL, Drizzle ORM
- **File Storage**: MinIO (S3-compatible)
- **AI**: OpenAI + Ollama (optional, self-hosted LLM)
- **Workflow Engine**: Temporal
- **Real-time**: Electric SQL with PGLite and shared worker

---



## Feature
super admin can create company and become compnay admin
company admin can invite user to company
user invite by magic link.
company admin/manager can create workspace and become workspace owner
new workspace can create from blank or from template library
owner can create folder, table, dashboard, view to a workspace
worksapce has it own navigation menu, owner can create folder, and move item into different order
table are "real" database table, owner/admin can create, update , delete column.
view are addition query method of a table, View Type should include
- Table ( group  table )
- Kanban 
- Gantt
- Calendar
- Gallery
- Tree
- Map
dashboard ard widget to show in a grid layout owner/admin can config
every table has follow setting to config, 
- detail view <- a grid layout like dashboard to display table row detail
- list view <- a column base layout to display in dropdown search.
- Card View <- a column base layout to display in other table related overlay
- Default Form <- a column baser form to let user to create new row data

workspace permission
the owner can add role to workspace.
default role of worksapce is admin(owner), user
but admin can edit role label, and add new role 
for example, a CRM workspace role can be
- Sales
- Region Manager
- Finance
- GM
- System Admin

## Technical design



### Database design
#### Remark

this project will use @electric-sql to sync user data to local, by @electric-sql limitation, it can only query filter "Shape" in target table, so all "premission" related column need to add to table.

for easy migrate , all uuid should create by user, can not use auto gen id in PG

1. User
```
export const users = pgTable('users', {
  id: uuid('id').primaryKey(),
  email: text('email').notNull().unique(),
  name: text('name'),
  avatar: text('avatar'),
  password: text('password').notNull(),
  emailVerifiedAt: timestamp('email_verified_at'),
  lastLoginAt: timestamp('last_login_at'),
  createdAt: timestamp('created_at').notNull().defaultNow(),
  updatedAt: timestamp('updated_at').notNull().defaultNow(),
})
```

2. Company
```
export const companies = pgTable('companies', {
  id: uuid('id').primaryKey(),
  name: text('name').notNull(),
  slug: text('slug').notNull().unique(),
  logo: text('logo'),
  description: text('description'),
  companyUsers: pgArray('companyUsers', 'uuid'), // reference all user in compnay for electric sql to use
  createdBy: uuid('created_by').references(() => users.id),
  createdAt: timestamp('created_at').notNull().defaultNow(),
  updatedAt: timestamp('updated_at').notNull().defaultNow(),
})
```

3. Company member
```
export const companyMembers = pgTable('company_members', {
  id: uuid('id').primaryKey(),
  companyId: uuid('company_id').notNull().references(() => companies.id, { onDelete: 'cascade' }),
  userId: uuid('user_id').notNull().references(() => users.id, { onDelete: 'cascade' }),
  role: text('role').notNull(), // 'owner', 'admin', 'member'
  createdAt: timestamp('created_at').notNull().defaultNow(),
  updatedAt: timestamp('updated_at').notNull().defaultNow(),
})

```

4. Company Invite
```
export const companyInvites = pgTable('company_invites', {
  id: uuid('id').primaryKey(),
  companyId: uuid('company_id').notNull().references(() => companies.id, { onDelete: 'cascade' }),
  email: text('email').notNull(),
  role: text('role').notNull(), // 'admin', 'member'
  inviteCode: text('invite_code').notNull().unique(),
  invitedBy: uuid('invited_by').notNull().references(() => users.id),
  acceptedAt: timestamp('accepted_at'),
  expiresAt: timestamp('expires_at').notNull(),
  createdAt: timestamp('created_at').notNull().defaultNow(),
})

```

5. Workspace
```

export const workspaces = pgTable('workspaces', {
  id: uuid('id').primaryKey(),
  name: text('name').notNull(),
  slug: text('slug').notNull(),
  icon: text('icon'),
  description: text('description'),
  menu: jsonb('menu').$type<MenuItem[]>(),
  companyId: uuid('company_id').notNull().references(() => companies.id, { onDelete: 'cascade' }),
  createdAt: timestamp('created_at').notNull().defaultNow(),
  updatedAt: timestamp('updated_at').notNull().defaultNow(),
}, (table) => ({
  // Composite unique constraint: slug must be unique within a company
  uniqueSlugPerCompany: unique().on(table.companyId, table.slug),
}))
```

6. Dynamic table Setting
```
export const dataTables = pgTable('data_tables', {
  id: uuid('id').primaryKey(),
  name: text('name').notNull(),
  slug: text('slug').notNull(),
  
  // Physical PostgreSQL table name (e.g., dt_abc123def456_8f3a4b2c1d9e)
  tableName: text('table_name').notNull().unique(),
  
  // References
  workspaceId: uuid('workspace_id')
    .notNull()
    .references(() => workspaces.id, { onDelete: 'cascade' }),
  companyId: uuid('company_id')
    .notNull()
    .references(() => companies.id, { onDelete: 'cascade' }),
  
  description: text('description'),
  
  // Layout configurations (null = use schema-based defaults, populated = user customized)
  formJson: jsonb('form_json'),           // Custom form builder layout
  cardJson: jsonb('card_json'),           // Custom card view layout
  dashboardJson: jsonb('dashboard_json'), // Custom dashboard layout
  listJson: jsonb('list_json'),           // Custom list/grid view layout
  
  // Timestamps
  createdAt: timestamp('created_at').notNull().defaultNow(),
  updatedAt: timestamp('updated_at').notNull().defaultNow(),
}, (table) => {
  return {
    // Slug is unique per workspace (allows same table name across different workspaces in same company)
    uniqueSlugPerWorkspace: unique().on(table.workspaceId, table.slug),
  }
})
```

7. Dynamic Table Columns
```
export const dataTableColumns = pgTable('data_table_columns', {
  id: uuid('id').primaryKey(),
  
  // Reference to parent table
  dataTableId: uuid('data_table_id')
    .notNull()
    .references(() => dataTables.id, { onDelete: 'cascade' }),
  // reference to workspace and company for query in electric sql
  workspaceId: uuid('workspace_id')
    .notNull()
    .references(() => workspaces.id, { onDelete: 'cascade' }),
  companyId: uuid('company_id')
    .notNull()
    .references(() => companies.id, { onDelete: 'cascade' }),
  
  // Column definition
  name: text('name').notNull(), // DB column name (snake_case)
  label: text('label').notNull(), // Display label
  type: text('type').notNull(), // text, long_text, number, date, switch
  
  // Column properties
  required: boolean('required').notNull().default(false),
  order: integer('order').notNull().default(0),
  
  // NEW: Extended field properties
  defaultValue: text('default_value'),
  isUnique: boolean('is_unique').notNull().default(false),
  isHidden: boolean('is_hidden').notNull().default(false), // Column visibility
  
  // Type-specific configuration (stored as JSONB) - EXPANDED
  config: jsonb('config').$type<{
    // Text field
    maxLength?: number
    minLength?: number
    placeholder?: string
    pattern?: string // Regex validation
    
    // Number field
    min?: number
    max?: number
    decimals?: number
    prefix?: string
    suffix?: string
    
    // Date/DateTime field
    dateFormatType?: 'date' | 'datetime' | 'time'
    dateFormatString? : string // YYYY-MM-DD, YYYY-MM-DD HH:MM:SS, HH:MM:SS
    minDate?: string
    maxDate?: string
    
    // Select/Multi-select field
    options?: Array<{
      label: string
      color?: string //hex, rgb, hsl
    }>
    allowCustom?: boolean
    maxSelections?: number // For multi-select
    
    // Rating field
    maxRating?: number // 5 or 10
    allowHalf?: boolean
    icon?: 'star' | 'heart' | 'thumb'
    
    // Currency field
    currency?: string // USD, EUR, etc.
    currencySymbol?: string // $, â‚¬, etc.
    compactDisplay?: boolean // Show as K, M, B, T
    compactThreshold?: number
    
    // Color field
    colorFormat?: 'hex' | 'rgb' | 'hsl'
    showAlpha?: boolean
    
    // Phone field
    phoneFormat?: 'US' | 'international' | 'E.164'
    
    // URL field
    allowedProtocols?: string[] // ['http', 'https']
    openInNewTab?: boolean
    
    // Email field
    strictValidation?: boolean
    
    // Formula field (complex)
    formula?: string
    returnType?: 'number' | 'text' | 'date' | 'boolean'
    dependencies?: string[] // Field IDs
    cacheResult?: boolean
    
    // Aggregation field (complex)
    operation?: 'SUM' | 'COUNT' | 'AVG' | 'MIN' | 'MAX'
    sourceTable?: string
    sourceField?: string
    groupBy?: string
    filter?: Record<string, any>
    
    // Relation field (complex)
    targetTable?: string // Table ID to link to
    displayField?: string // Which field to show
    allowMultiple?: boolean
    cascadeDelete?: 'restrict' | 'cascade' | 'set_null'
    
    // Lookup field (complex)
    relationField?: string // Which relation to use
    targetField?: string // Field from related record
    allowNested?: boolean
    autoUpdate?: boolean
    
    // Generic
    description?: string
    helpText?: string
  }>(),
  
  // NEW: Validation rules (stored as JSONB)
  validationRules: jsonb('validation_rules').$type<{
    email?: boolean
    url?: boolean
    phone?: boolean
    pattern?: string
    minLength?: number
    maxLength?: number
    min?: number
    max?: number
    unique?: boolean
    custom?: string // Custom validation function name
  }>(),
  
  // Timestamps
  createdAt: timestamp('created_at').notNull().defaultNow(),
  updatedAt: timestamp('updated_at').notNull().defaultNow(),
})
```


8. Dynamic Table View 
```

export const dataTableViews = pgTable('data_table_views', {
  id: uuid('id').primaryKey(),
  
  // Reference to parent table
  dataTableId: uuid('data_table_id')
    .notNull()
    .references(() => dataTables.id, { onDelete: 'cascade' }),
  // reference to workspace and company for query in electric sql
  workspaceId: uuid('workspace_id')
    .notNull()
    .references(() => workspaces.id, { onDelete: 'cascade' }),
  companyId: uuid('company_id')
    .notNull()
    .references(() => companies.id, { onDelete: 'cascade' }),
  
  // View metadata
  name: text('name').notNull(), // e.g., "All Records", "Active Only", "My Tasks"
  slug: text('slug').notNull(), // URL-friendly
  description: text('description'), // Optional description of what the view shows
  viewType: text('view_type').notNull().default('grid'), // 'grid' | 'kanban' | 'calendar' | 'gantt' | 'gallery' | 'form'
  
  // Default view flag (only one default per table)
  isDefault: boolean('is_default').notNull().default(false),
  
  // Sharing settings
  isShared: boolean('is_shared').notNull().default(false), // Shared with team (requires permissions)
  isPublic: boolean('is_public').notNull().default(false), // Public access (no login required)
  
  // Column configuration
  visibleColumns: jsonb('visible_columns').$type<string[]>(), // Array of column IDs in display order
  columnWidths: jsonb('column_widths').$type<Record<string, number>>(), // Custom column widths in pixels
  
  // Filtering - supports nested AND/OR conditions
  filters: jsonb('filters').$type<{
    operator: 'AND' | 'OR'
    conditions: Array<{
      columnId: string
      operator: 'equals' | 'notEquals' | 'contains' | 'notContains' | 'startsWith' | 'endsWith' | 
                'isEmpty' | 'isNotEmpty' | 'gt' | 'gte' | 'lt' | 'lte' | 'between' | 'in' | 'notIn'
      value?: any
      // Nested conditions for complex filters
      conditions?: Array<{
        operator: 'AND' | 'OR'
        conditions: any[]
      }>
    }>
  }>(),
  
  // Sorting - multiple sort criteria
  sort: jsonb('sort').$type<Array<{
    columnId: string
    direction: 'asc' | 'desc'
  }>>(),
  
  // View-specific settings based on type
  viewConfig: jsonb('view_config').$type<{
    // Table/Grid view
    rowHeight?: 'compact' | 'default' | 'tall' | 'extra-tall'
    showRowNumbers?: boolean
    wrapCellContent?: boolean
    
    // Kanban view
    groupByColumn?: string // Column to group by (usually a select/status field)
    cardFields?: string[] // Which fields to show on cards
    cardCoverColumn?: string // Cover image for cards
    
    // Calendar view
    dateColumn?: string // Which date column to use for positioning
    endDateColumn?: string // For date ranges/events
    colorByColumn?: string // Color code events by this field
    viewMode?: 'month' | 'week' | 'day' | 'agenda'
    
    // Gantt view
    startDateColumn?: string
    endDateColumn?: string
    progressColumn?: string // Progress percentage (0-100)
    dependenciesColumn?: string // For task dependencies
    
    // Gallery/Card view
    coverImageColumn?: string
    titleColumn?: string
    cardLayout?: 'grid' | 'list' | 'masonry'
    cardsPerRow?: number
  }>(),
  
  // Created by (track who created custom views)
  createdBy: uuid('created_by').references(() => users.id, { onDelete: 'set null' }),
  
  // Timestamps
  createdAt: timestamp('created_at').notNull().defaultNow(),
  updatedAt: timestamp('updated_at').notNull().defaultNow(),
}, (table) => {
  return {
    // Slug is unique per table
    uniqueSlugPerTable: unique().on(table.dataTableId, table.slug),
  }
})
```

9. Dynamic table Dashboard
```
export const dataTableDashboard = pgTable('data_table_columns', {
  id: uuid('id').primaryKey(),
  workspaceId: uuid('workspace_id')
    .notNull()
    .references(() => workspaces.id, { onDelete: 'cascade' }),
  companyId: uuid('company_id')
    .notNull()
    .references(() => companies.id, { onDelete: 'cascade' }),
  viewConfig: JSONB('viewConfig').$type<{
    widget: {
        id:string,
        label:string,
        component: string,
        position:{
            x:string,
            y:string,
            width: string,
            height: string,
            minWidth: string,
            minHeight: string,
        },
        props:any
    }[]
  }>
    // Created by (track who created custom views)
  createdBy: uuid('created_by').references(() => users.id, { onDelete: 'set null' }),
  
  // Timestamps
  createdAt: timestamp('created_at').notNull().defaultNow(),
  updatedAt: timestamp('updated_at').notNull().defaultNow(),
})
```


10. Workspace Role 
```
export const workspaceRole = pgTable('workspace_role',{
    id: uuid('id').primaryKey(),
    label: Text('label').notNull(),
    workspaceId: uuid('workspace_id')
        .notNull()
        .references(() => workspaces.id, { onDelete: 'cascade' }),
    companyId: uuid('company_id')
        .notNull()
        .references(() => companies.id, { onDelete: 'cascade' })
    permission: bytea('permission').notNull() // bitwise binary number to store permissions, 1 for read, 10 for write, 100 for manage, 1000 for delete ...etc
},(table) => {
  return {
    // Slug is unique per table
    uniqueLabelPerWorkspace: unique().on(table.workspaceId, table.label),
  }
})
```

11. table/view/dashboard Permission 
```
export const tableViewDashboardPermission = pgTable('table_view_dashboard_permission', {
    id: uuid('id').primaryKey(),
    type : Text('type').notNull() //  table | view | dashbaord,
    tableId: uuid('relatedId')
        .reference(() => dataTables.id, { onDelete: 'cascade' }),
    viewId: uuid('viewId')
        .reference(() => dataTableViews.id, { onDelete: 'cascade' }),
    dashboardId: uuid('dashboardId')
        .reference(() => dataTableDashboard.id, { onDelete: 'cascade' }),
    roles: pgArray('roles', 'uuid'), // which role apply to this permission
    workspaceId: uuid('workspace_id')
        .notNull()
        .references(() => workspaces.id, { onDelete: 'cascade' }),
    companyId: uuid('company_id')
        .notNull()
        .references(() => companies.id, { onDelete: 'cascade' })
    permission: bytea('permission').notNull() // bitwise binary number to store permissions, 1 for read, 10 for write, 100 for manage, 1000 for delete ...etc
})
```

12, User permission lookup
```
// this table is to hold all id a user can view, so electricsql can use this to create user special shape.
export const userPermissionLookup = pgTable('user_permission_lookup', {
    id: uuid('id').primaryKey(),
    userId: uuid('userId').reference(() => users.id, { onDelete: 'cascade' })
    companies: pgArray('companies', 'uuid'),
    workspaces:  pgArray('workspace', 'uuid'),
    tables:  pgArray('tables', 'uuid'),
    views: pgArray('views', 'uuid'),
    dashboards: pgArray('dashboards', 'uuid'),
})
```